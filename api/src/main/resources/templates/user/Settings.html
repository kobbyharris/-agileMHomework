<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script th:src="@{/js/main.js}"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        /* Modal Close Button */
        .modal .text-2xl {
            position: absolute;
            top: 1rem;
            right: 1rem;
        }
        /* Hide the scrollbar track */
        ::-webkit-scrollbar {
            width: 10px; /* Define the width of the scrollbar */
            background: transparent; /* Make the track invisible */
        }

        /* Customize the scrollbar thumb (scrolling bar) */
        ::-webkit-scrollbar-thumb {
            background: #888; /* Gray color for the scrollbar thumb */
            border-radius: 50px; /* Full curve for the scrollbar thumb */
            height: 20%; /* Makes the thumb shorter */
            background-clip: padding-box;
        }

        /* Hover effect for the scrollbar thumb */
        ::-webkit-scrollbar-thumb:hover {
            background: #555; /* Darker gray on hover */
        }

        /* For Firefox: make scrollbar thin and short */
        * {
            scrollbar-width: thin; /* Thin scrollbar */
            scrollbar-color: #888 transparent; /* Visible thumb, hidden track */
        }

        /* Optional: Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
    </style>
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('hidden');
        }

        function toggleDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('hidden');
        }

        document.addEventListener('click', function (event) {
            const dropdown = document.getElementById('profileDropdown');
            const button = document.getElementById('profileButton');

            if (!button.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.classList.add('hidden');
            }
        });
    </script>
</head>
<body class="bg-gray-50 font-sans">
    <div class="flex h-screen">
        <!--sidebar-->
        <div th:insert="user/fragments/sidebar :: sidebar"></div>
        <!--sidebar end-->


        <!-- Main Content -->
        <div class="flex-1 bg-white overflow-y-auto">

            <!-- Header -->
            <div th:insert="user/fragments/header :: header"></div>
            <!--header end-->


            <!-- Navigation Section -->
            <div th:insert="user/fragments/header :: navigation"></div>

            <!-- Profile Section -->
            <div class="m-4 bg-white rounded-lg shadow">
                <div class="px-4 py-2 text-lg font-semibold border-b border-gray-200">Profile</div>
                <div class="p-4">
                    <form id="profile-form" class="space-y-4">
                        <div>
                            <label for="profile-name" class="block text-sm font-medium text-gray-700">Name</label>
                            <input type="text" id="profile-name" placeholder="Enter your name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="profile-email" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="profile-email" placeholder="Enter your email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                        <button type="submit" class="px-4 py-2 text-white bg-gray-700 hover:bg-gray-600 rounded-md">Update Profile</button>
                    </form>
                </div>
            </div>

            <!-- Security Section -->
            <div class="m-4 bg-white rounded-lg shadow">
                <div class="px-4 py-2 text-lg font-semibold border-b border-gray-200">Security</div>
                <div class="p-4">
                    <form id="security-form" class="space-y-4">
                        <div>
                            <label for="current-password" class="block text-sm font-medium text-gray-700">Current Password</label>
                            <input 
                                type="password" 
                                id="current-password" 
                                placeholder="Enter current password" 
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                            >
                        </div>
                        <div>
                            <label for="new-password" class="block text-sm font-medium text-gray-700">New Password</label>
                            <input 
                                type="password" 
                                id="new-password" 
                                placeholder="Enter new password" 
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                            >
                        </div>
                        <div>
                            <label for="confirm-password" class="block text-sm font-medium text-gray-700">Confirm New Password</label>
                            <input 
                                type="password" 
                                id="confirm-password" 
                                placeholder="Confirm new password" 
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                            >
                        </div>
                        <button 
                            type="submit" 
                            class="px-4 py-2 text-white bg-gray-700 hover:bg-gray-600 rounded-md"
                        >
                            Change Password
                        </button>
                    </form>
                </div>
            </div>


        </div>
    </div>

    <script>
        // Utility Function to Retrieve Auth Token
        const getAuthToken = () => localStorage.getItem('authToken') || '';

        // Utility Function for API Requests
        async function apiRequest(url, method, body = null) {
            try {
                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                };

                const options = { method, headers };
                if (body) options.body = JSON.stringify(body);

                const response = await fetch(url, options);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'An error occurred');
                }

                return data;
            } catch (error) {
                console.error(`API Error: ${error.message}`);
                alert(`Error: ${error.message}`);
                throw error;
            }
        }

        async function updateProfile(event) {
            event.preventDefault(); // Prevent default form submission

            const name = document.getElementById('profile-name').value.trim();
            const email = document.getElementById('profile-email').value.trim();

            if (!name || !email) {
                return alert('Please fill in both Name and Email fields.');
            }

            try {
                await apiRequest('http://localhost:8080/api/user/profile', 'PUT', { name, email });
                alert('Profile updated successfully!');
            } catch (error) {
                console.error('Failed to update profile:', error);
            }
        }

        async function changePassword(event) {
            event.preventDefault(); // Prevent default form submission

            const currentPassword = document.getElementById('current-password').value.trim();
            const newPassword = document.getElementById('new-password').value.trim();
            const confirmPassword = document.getElementById('confirm-password').value.trim();

            if (!currentPassword || !newPassword || !confirmPassword) {
                return alert('Please fill in all password fields.');
            }

            if (newPassword !== confirmPassword) {
                return alert('New passwords do not match!');
            }

            try {
                await apiRequest('http://localhost:8080/api/user/change-password', 'POST', {
                    currentPassword,
                    newPassword,
                });
                alert('Password changed successfully!');
            } catch (error) {
                console.error('Failed to change password:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('profile-form')?.addEventListener('submit', updateProfile);
            document.getElementById('security-form')?.addEventListener('submit', changePassword);
        });
    </script>
</body>
</html>
